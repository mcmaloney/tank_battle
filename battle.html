<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <title>TANK BATTLE</title>
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map_canvas { height: 100% }
    </style>
    <script type="text/javascript"
      src="http://maps.googleapis.com/maps/api/js?libraries=geometry&sensor=true">
    </script>
    <script type="text/javascript">
      // Map Vars
      var currentLocation = new Array();
      var marker1;
      var marker2;
      var geodesicPoly;
      var poly;
      
      // Projectile
      var maxProjectileSpeed = 350; // Meters per second
      
      // Setup map, initial markers, paths.
      function initialize() {
        getCurrentLocation();
        var myOptions = {
          center: new google.maps.LatLng(40.71435280, -74.0059731),
          zoom: 5,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        var map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
        
        map.controls[google.maps.ControlPosition.TOP].push(document.getElementById("info"));
        
        marker1 = new google.maps.Marker({
          map: map,
          draggable: false,
          position: new google.maps.LatLng(40.71435280, -74.0059731)
        });
        
        marker2 = new google.maps.Marker({
          map: map,
          draggable: true,
          position: new google.maps.LatLng(48.8566140, 2.35222190)
        });
        
        var bounds = new google.maps.LatLngBounds(marker1.getPosition(), marker2.getPosition());
        map.fitBounds(bounds);
        
        google.maps.event.addListener(marker1, 'position_changed', update);
        google.maps.event.addListener(marker2, 'position_changed', update);
        
        var polyOptions = {
          strokeColor: '#000000',
          strokeOpacity: 1.0,
          strokeWeight: 3,
          map: map
        }
        
        poly = new google.maps.Polyline(polyOptions);
        
        var geodesicOptions = {
          strokeColor: '#FFAAAA',
          strokeOpacity: 1.0,
          strokeWeight: 3,
          geodesic: true,
          map: map
        }
        
        geodesicPoly = new google.maps.Polyline(geodesicOptions);
        
        update();
      }
      
      // Update the distance between markers and paths if they are dragged somewhere else.
      function update() {
        var path = [marker1.getPosition(), marker2.getPosition()];
        poly.setPath(path);
        geodesicPoly.setPath(path);
        var heading = google.maps.geometry.spherical.computeHeading(path[0], path[1]);
      }
      
      // Find the user's current location. Use it as the lat/lng for the first marker.
      function getCurrentLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            currentLocation[0] = position.coords.latitude;
            currentLocation[1] = position.coords.longitude;
            console.log(currentLocation);
          });
        } else {
          handleNoGeolocation(false);
        }
      }
      
      // If geolocation for first marker placement fails.
      function handleNoGeolocation(errorFlag) {
        if (errorFlag) {
          alert("Geolocation failed");
        } else {
          "Your browser does not support geolocation.";
        }
      }
      
      // Spherical/geodesic distance
      function calculateDistanceBetween(origin, destination) {
        var distance = google.maps.geometry.spherical.computeDistanceBetween(origin, destination) / 100;
        return distance;
      }
      
      // Outputs the difference between distance to target and projectile distance traveled based on launch vars.
      function fireProjectile() {
        var targetDistance = calculateDistanceBetween(marker1.getPosition(), marker2.getPosition());
        // Initial velocity is basically "Power" 
        var initialVelocity = parseFloat(document.launchVars.initalVelocity.value);
        var launchAngle = parseFloat(document.launchVars.launchAngle.value);    
        var launchHeight = parseFloat(document.launchVars.launchHeight.value);
        var distanceDifference = Math.round(1000.0 * (findLaunchResults(initialVelocity, launchAngle, launchHeight) - targetDistance))/1000.0
        document.launchResults.distance.value = distanceDifference;
      }
      
      function findLaunchResults(velocity, angle, height) {
        if ((angle > 90.0)||(angle < 0.0)||(velocity < 0.0)) {
          alert("You must enter appropriate launch values.");
        }

        angle = (Math.PI/180.0)*angle; // convert to radians

        var Ge = parseFloat(9.81);          // acceleration of gravity -- meters/sec/sec
        var Vx = velocity*Math.cos(angle);  // init horizontal velocity
        var Vy = velocity*Math.sin(angle);  // init vertical velocity

        var hgt = height + Vy*Vy/(2*Ge); // max height

        if (hgt < 0.0) return;

        var upt = Vy/Ge;                      // time to max height
        var dnt = Math.sqrt(2*hgt/Ge);        // time from max height to impact
        var rng = Vx*(upt + dnt);             // horizontal range at impact

        // flight time to impact, speed at impact
        var imp = upt + dnt;
        var spd = Math.sqrt((Ge*dnt)*(Ge*dnt) + Vx*Vx);
        
        // Just return the range for now since that's all we really want.
        return rng;
      }
      
      google.maps.event.addDomListener(window, 'load', initialize);
    </script>
  </head>
  <body>
    <div id="map_canvas" style="width:100%; height:100%"></div>
    <div id="info">
      <form name="launchVars">
        Launch Velocity: <input type="text" name="initalVelocity" />
        Launch Angle: <input type="text" name="launchAngle" />
        Launch Height: <input type="text" name="launchHeight" />
        <input type="button" value="Fire" onclick="fireProjectile()">
      </form>
      <form name="launchResults">
        <input type="text" name="distance" "readonly" />
      </form>
    </div>
  </body>
</html>